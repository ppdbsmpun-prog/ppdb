<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PPDB SMP Islam Ulun Nuha</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- html2canvas untuk export PNG -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- jsPDF untuk export PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>



</head>

<body class="bg-gradient-to-br from-green-50 to-green-100 min-h-screen flex flex-col">

  


<!-- Header -->
<header class="bg-green-600 text-white p-4 flex justify-between items-center shadow-md">
  <!-- Kiri: Logo + Judul -->
  <div class="flex items-center gap-3">
    <!-- Logo Sekolah -->
    <img src="user.png" alt="user" class="w-8 h-8 rounded-full border-0  shadow-md object-cover">
    <div>
    
      <p id="userInfo" class="text-sm opacity-90 mt-0.5">(Nama Siswa - NIK)</p>
    </div>
  </div>


  <button id="logoutBtn"
    class="flex items-center gap-2 bg-red-500 hover:bg-red-600 transition-all px-3 py-2 rounded-lg text-sm font-medium shadow-sm active:scale-95">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"
      stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M17 16l4-4m0 0l-4-4m4 4H9m4 4v1a2 2 0 01-2 2H8a2 2 0 01-2-2v-1m0-4V9m0 0V5a2 2 0 012-2h3a2 2 0 012 2v4" />
    </svg>
  </button>
</header>

<!-- Navigasi Atas-->
<div class="sticky top-0 z-10 bg-white shadow-sm border-b mb-4">
  <div id="infoLengkap"></div> 
  <div class="flex flex-wrap justify-around text-center text-sm font-semibold overflow-x-auto">
    <button id="tab-beranda"
      class="tab-btn flex-1 min-w-[100px] py-3 text-green-700 border-b-2 border-green-600 bg-green-50 transition">
      Beranda
    </button>
    <button id="tab-casisba"
      class="tab-btn flex-1 min-w-[100px] py-3 text-gray-600 border-b-2 border-transparent hover:bg-gray-50 transition">
      Calon Siswa
    </button>
    <button id="tab-saudara"
      class="tab-btn flex-1 min-w-[100px] py-3 text-gray-600 border-b-2 border-transparent hover:bg-gray-50 transition">
      Saudara Kandung
    </button>
    <button id="tab-pernyataan"
      class="tab-btn flex-1 min-w-[100px] py-3 text-gray-600 border-b-2 border-transparent hover:bg-gray-50 transition">
      Pernyataan
    </button>
    <button id="tab-pengumuman"
      class="tab-btn flex-1 min-w-[100px] py-3 text-gray-600 border-b-2 border-transparent hover:bg-gray-50 transition">
      Pengumuman
    </button>
  </div>
</div>
  





<!-- Konten Utama -->
<main class="flex-grow flex justify-center items-start mt-6 px-4 pb-8">
  <div class="bg-white w-full max-w-2xl p-6 rounded-2xl shadow-xl border border-gray-200 animate-fadeIn">
    

    <form id="dataForm" class="space-y-6">
      <input type="hidden" id="tanggalDaftar" name="tanggalDaftar" required>
      <input type="hidden" id="noPendaftaran" name="noPendaftaran" required>

            <!-- Beranda -->
    <div id="tab-content-beranda" class="p-4 sm:p-6">
      
      <!-- Header Sekolah -->
      <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-md mb-6 text-center flex flex-col items-center">
      
        <img src="logo.png" alt="Logo SMP Islam Ulun Nuha" class="w-16 sm:w-32 mb-3">
        
        
        <h1 class="text-base sm:text-lg md:text-2xl font-bold mb-1 text-center">PPDB SMP Islam Ulun Nuha</h1>
        
        <p class="text-gray-700 text-sm sm:text-base">Ahlan Wa sahlan, <span id="userNama">Siswa</span>
      </div>

      <!-- Syarat Pengisian Form -->
      <div id="syaratPengisian" class="bg-white p-4 sm:p-6 rounded-2xl shadow-md space-y-2 sm:space-y-4 hidden">
        <h2 class="text-lg sm:text-xl font-semibold mb-2">Syarat Pengisian Form PPDB</h2>
        <ul class="list-disc list-inside text-gray-700 text-sm sm:text-base space-y-1">
          <li>Isi semua field yang wajib (ditandai *)</li>
          <li>Siapkan dokumen pendukung (KK dan Surat Keterangan Aktif Saudara Kandung) untuk diunggah</li>
          <li>Periksa kembali data sebelum menekan tombol "Simpan"</li>
          <li>Data harus sesuai dengan kartu keluarga</li>
        </ul>

          </div> <br>


      

        <button type="button"  id="startForm" hidden
          class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
          Mulai Isi Form
        </button>

        <div class="flex justify-center mt-1">
        <button 
          type="button" 
          id="previewBuktiBtn"
          class="hidden bg-green-50 border border-green-300 text-green-700 font-semibold px-6 py-3 rounded-xl shadow hover:bg-green-100 transition-all duration-200 text-center w-full sm:w-auto">
          Lihat Bukti Daftar
        </button>
      </div>

      </div>

  


      <!-- STEP 1: Data Calon Siswa -->
      <div id="step1" class="step space-y-4">
        <h3 class="font-semibold text-green-600 text-lg">1Ô∏è‚É£ Data Calon Siswa</h3>
        <div>
          <label for="namaSiswa" class="block text-gray-700 font-medium mb-1">Nama Siswa</label>
          <input type="text" id="namaSiswa" name="namaSiswa" placeholder="Masukkan nama lengkap" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-400 outline-none" required>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label for="tempat" class="block text-gray-700 font-medium mb-1">Tempat Lahir</label>
            <input type="text" id="tempat" name="tempat" placeholder="Tempat lahir" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-400 outline-none" required>
          </div>
          <div>
            <label for="tanggal" class="block text-gray-700 font-medium mb-1">Tanggal Lahir</label>
            <input type="date" id="tanggal" name="tanggal" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-400 outline-none" required>
          </div>
        </div>

        <div>
          <label for="jk" class="block text-gray-700 font-medium mb-1">Jenis Kelamin</label>
          <select id="jk" name="jk" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-400 outline-none" required>
            <option value="">Pilih Jenis Kelamin</option>
            <option value="L">Laki-laki</option>
            <option value="P">Perempuan</option>
          </select>
        </div>

        <div>
          <label for="anakke" class="block text-gray-700 font-medium mb-1">Anak ke</label>
          <input type="number" id="anakke" name="anakke" placeholder="Contoh: 1" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-400 outline-none" required>
        </div>

        <div>
          <label for="alamat" class="block text-gray-700 font-medium mb-1">Alamat Lengkap</label>
          <textarea id="alamat" name="alamat" placeholder="Masukkan alamat lengkap" rows="3" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-400 outline-none resize-none" required></textarea>
        </div>

        <div>
          <label for="namaAyah" class="block text-gray-700 font-medium mb-1">Nama Ayah</label>
          <input type="text" id="namaAyah" name="namaAyah" placeholder="Nama Ayah Kandung" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-400 outline-none" required>
        </div>

        <div>
          <label for="namaIbu" class="block text-gray-700 font-medium mb-1">Nama Ibu</label>
          <input type="text" id="namaIbu" name="namaIbu" placeholder="Nama Ibu Kandung" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-400 outline-none" required>
        </div>

        <div>
          <label for="sekolahAsal" class="block text-gray-700 font-medium mb-1">Sekolah Asal</label>
          <input type="text" id="sekolahAsal" name="sekolahAsal" placeholder="Contoh: SDN 1 Padang" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-400 outline-none" required>
        </div>

        

        <button type="button" id="next1" class="w-full bg-green-600 text-white font-semibold p-3 rounded-xl shadow hover:bg-green-700 transition">
          Selanjutnya ‚Üí
        </button>
      </div>

      <!-- STEP 2: Data Saudara Kandung -->
      <div id="step2" class="step hidden space-y-4">
        <h3 class="font-semibold text-green-600 text-lg">2Ô∏è‚É£ Data Saudara Kandung</h3>

        

        <div>
          <label for="unitSaudara" class="block text-gray-700 font-medium mb-1">Unit Saudara Kandung</label>
          <select id="unitSaudara" name="unitSaudara" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-400 outline-none" required>
            <option value="">Pilih Unit</option>
            <option value="RA">RA</option>
            <option value="SD">SD</option>
            <option value="SMP">SMP</option>
            <option value="SMA">SMA</option>
            <option value="IMUN">IMUN</option>
          </select>
        </div>

        <!-- NAMA SAUDARA KANDUNG (dinamis, id tetap 'namaSaudara') -->
      <div class="mb-4">
  <label class="block mb-1 font-medium text-gray-700">Nama Saudara Kandung</label>
  <div id="namaSaudaraContainer">
    <!-- script akan isi otomatis di sini -->
    <input type="text" id="namaSaudara" placeholder="Tulis nama saudara kandung"
      class="border rounded-lg p-2 w-full">
  </div>
</div>
        

        <div class="bg-green-50 p-3 rounded-xl border border-green-200">
          <label for="kkFile" class="block font-medium text-gray-700 mb-1">Kartu Keluarga (KK):</label>
          <span id="kkLink" class="text-sm text-gray-600">Belum upload</span>
          <input type="file" id="kkFile" accept="image/*,.pdf" class="w-full mt-2 text-sm border p-2 rounded-lg bg-white">
        </div>

        <div id="skContainer" class="bg-green-50 p-3 rounded-xl border border-green-200">
        <label for="skFile" class="block font-medium text-gray-700 mb-1">
          Surat Keterangan Aktif Saudara Kandung:
        </label>
        <span id="skLink" class="text-sm text-gray-600">Belum upload</span>
        <input type="file" id="skFile" accept="image/*,.pdf" class="w-full mt-2 text-sm border p-2 rounded-lg bg-white">
      </div>


        <div class="flex gap-3">
          <button type="button" id="prev2" class="flex-1 bg-gray-300 text-gray-800 font-semibold p-3 rounded-xl shadow hover:bg-gray-400 transition">
            ‚Üê Sebelumnya
          </button>
          <button type="button" id="next2" class="flex-1 bg-green-600 text-white font-semibold p-3 rounded-xl shadow hover:bg-green-700 transition">
            Selanjutnya ‚Üí
          </button>
        </div>
      </div>

      <!-- STEP 3: Pernyataan -->
      <div id="step3" class="step hidden space-y-4">
        <h3 class="font-semibold text-green-600 text-lg">3Ô∏è‚É£ Pernyataan Kebenaran Data</h3>

        <div class="bg-green-50 border border-green-200 rounded-xl p-4 space-y-3 text-gray-700">
          <p class="text-sm leading-relaxed">
            Dengan ini saya menyatakan bahwa seluruh data yang saya isi dalam formulir pendaftaran ini adalah
            <span class="font-semibold text-green-700">benar dan dapat dipertanggungjawabkan</span>.
          </p>

          <label class="flex items-center gap-2 mt-3">
            <input type="checkbox" id="setuju" class="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500" required>
            <span class="text-sm">Saya menyetujui pernyataan di atas</span>
          </label>
        </div>

        <div class="flex gap-3">
          <button type="button" id="prev3" class="flex-1 bg-gray-300 text-gray-800 font-semibold p-3 rounded-xl shadow hover:bg-gray-400 transition">
            ‚Üê Sebelumnya
          </button>
          <button type="submit" id="saveBtn" class="flex-1 bg-green-600 text-white font-semibold p-3 rounded-xl shadow hover:bg-green-700 transition">
            Simpan Data
          </button>
          <button type="button" id="previewBuktiBtn" class="hidden flex-1 bg-green-50 border border-green-300 text-green-700 font-semibold p-3 rounded-xl shadow hover:bg-green-100 transition">
            Lihat Bukti Daftar
          </button>
        </div>

       
      </div>

       <!-- Tab Pengumuman -->
        <div id="tab-content-pengumuman" class="tab-content hidden">
          <div class="bg-white p-4 rounded-xl shadow">
            <h2 class="text-lg font-bold mb-2 text-green-700">Pengumuman PPDB</h2>
            <p id="isiPengumuman" class="text-gray-700 whitespace-pre-line leading-relaxed">
              Tidak ada pengumuman untuk saat ini.
            </p>
          </div>
        </div>

    </form>
  </div>
</main>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbyjbWKYY3eM92LoyHxOq2jJ-Cw6fKwwr-B-nFVubfd0fmP-1p-TKQTLVV5dYdbX_mEv/exec';

document.getElementById('unitSaudara').addEventListener('change', async function() {
  const unit = this.value;
  const container = document.getElementById('namaSaudaraContainer');
  const skDiv = document.getElementById('skContainer'); // üéØ ambil elemen SK dengan ID pasti
  const skFile = document.getElementById('skFile');

  // Bersihkan isi nama saudara
  container.innerHTML = '';

  if (unit === 'SMP') {
    // üîπ Sembunyikan bagian SK
    if (skDiv) skDiv.style.display = 'none';
    if (skFile) skFile.required = false;

    // üîπ Buat dropdown custom
    const wrapper = document.createElement('div');
    wrapper.className = 'relative w-full';

    const inputDisplay = document.createElement('input');
    inputDisplay.type = 'text';
    inputDisplay.id = 'namaSaudara';
    inputDisplay.placeholder = 'Memuat data nama...';
    inputDisplay.readOnly = true;
    inputDisplay.className = 'border rounded-lg p-2 w-full cursor-wait bg-gray-100 text-gray-500';
    wrapper.appendChild(inputDisplay);

    const dropdown = document.createElement('div');
    dropdown.className = 'absolute z-50 bg-white border rounded-lg mt-1 w-full hidden shadow max-h-60 overflow-y-auto';

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Cari nama...';
    searchInput.className = 'p-2 border-b w-full outline-none';
    dropdown.appendChild(searchInput);

    const list = document.createElement('ul');
    dropdown.appendChild(list);

    wrapper.appendChild(dropdown);
    container.appendChild(wrapper);

    try {
      const res = await fetch(`${scriptURL}?action=getNamaSMP`);
      const data = await res.json();

      inputDisplay.placeholder = 'Pilih Nama Siswa';
      inputDisplay.className = 'border rounded-lg p-2 w-full cursor-pointer bg-white';

      renderList(data);

      function renderList(items) {
        list.innerHTML = '';
        items.forEach(nama => {
          const li = document.createElement('li');
          li.textContent = nama;
          li.className = 'p-2 hover:bg-green-100 cursor-pointer';
          li.addEventListener('click', () => {
            inputDisplay.value = nama;
            dropdown.classList.add('hidden');
          });
          list.appendChild(li);
        });
      }

      searchInput.addEventListener('input', () => {
        const keyword = searchInput.value.toLowerCase();
        const filtered = data.filter(nama => nama.toLowerCase().includes(keyword));
        renderList(filtered);
      });

      inputDisplay.addEventListener('click', () => {
        dropdown.classList.toggle('hidden');
        searchInput.focus();
      });

      document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) dropdown.classList.add('hidden');
      });

    } catch (err) {
      inputDisplay.placeholder = 'Gagal memuat data nama';
      inputDisplay.className = 'border rounded-lg p-2 w-full bg-red-50 text-red-500 cursor-not-allowed';
    }

  } else if (unit !== '') {
    // üîπ Tampilkan kembali SK
    if (skDiv) skDiv.style.display = 'block';
    if (skFile) skFile.required = true;

    const input = document.createElement('input');
    input.type = 'text';
    input.id = 'namaSaudara';
    input.placeholder = 'Tulis nama saudara kandung';
    input.className = 'border rounded-lg p-2 w-full';
    container.appendChild(input);
  } else {
    // üîπ Jika belum pilih unit
    if (skDiv) skDiv.style.display = 'block';
    if (skFile) skFile.required = true;
  }
});
</script>





<script>
function setupFileValidation(inputId) {
  document.getElementById(inputId).addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.size > 2 * 1024 * 1024) { // 2MB
      Swal.fire({
        icon: 'error',
        title: 'Ukuran File Terlalu Besar!',
        text: 'Maksimal ukuran file adalah 2 MB.',
        confirmButtonColor: '#16a34a',
      });
      e.target.value = '';
    }
  });
}

// Terapkan ke dua input
setupFileValidation('kkFile');
setupFileValidation('skFile');
</script>


<script>
  document.getElementById('kkFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file && file.size > 2 * 1024 * 1024) { // 2MB
    Swal.fire({
      icon: 'error',
      title: 'Ukuran File Terlalu Besar!',
      text: 'Maksimal ukuran file adalah 2 MB.',
      confirmButtonColor: '#16a34a', 
    });
    e.target.value = ''; // reset file input
  }
});
document.addEventListener('DOMContentLoaded', () => {
  const tabs = document.querySelectorAll('.tab-btn');
  const steps = ['tab-content-beranda','step1', 'step2', 'step3', 'tab-content-pengumuman'];

  document.getElementById('startForm').addEventListener('click', () => {
  showTab('tab-casisba'); // langsung tampilkan tab pertama "Calon Siswa"
});

  function showTab(tabId) {
    steps.forEach(step => document.getElementById(step).classList.add('hidden'));
    tabs.forEach(btn => {
      btn.classList.remove('text-green-700', 'border-green-700', 'bg-green-50');
      btn.classList.add('text-gray-600', 'border-transparent');
    });

    let activeStep;
    switch(tabId) {
      case 'tab-beranda': activeStep='tab-content-beranda'; break;
      case 'tab-casisba': activeStep='step1'; break;
      case 'tab-saudara': activeStep='step2'; break;
      case 'tab-pernyataan': activeStep='step3'; break;
      case 'tab-pengumuman': activeStep='tab-content-pengumuman'; break;
    }

    document.getElementById(activeStep).classList.remove('hidden');
    document.getElementById(tabId).classList.add('text-green-700', 'border-green-700', 'bg-green-50');
  }

  function validateStep(stepId) {
    const inputs = document.querySelectorAll(`#${stepId} input[required], #${stepId} select[required], #${stepId} textarea[required]`);
    for (let input of inputs) {
      if (!input.value.trim()) {
        Swal.fire({
          icon: 'warning',
          title: 'Lengkapi Data',
          text: 'Mohon isi semua field sebelum melanjutkan.',
        });
        input.focus();
        return false;
      }
    }
    return true;
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Jika tab Beranda, langsung tampilkan tanpa validasi
      if(tab.id === 'tab-beranda'){
        showTab(tab.id);
        return;
      }

      const currentStep = steps.map(id => document.getElementById(id)).find(el => !el.classList.contains('hidden'));
      if (!currentStep) return;

      if (validateStep(currentStep.id)) {
        showTab(tab.id);
      }
    });
  });

  // Tombol "Selanjutnya" & "Sebelumnya"
  document.getElementById('next1').addEventListener('click', () => {
    if (validateStep('step1')) showTab('tab-saudara');
  });
  document.getElementById('next2').addEventListener('click', () => {
    if (validateStep('step2')) showTab('tab-pernyataan');
  });
  document.getElementById('prev2').addEventListener('click', () => showTab('tab-casisba'));
  document.getElementById('prev3').addEventListener('click', () => showTab('tab-saudara'));

  // Tampilkan Beranda awal
  showTab('tab-beranda');
});




</script>




  



    <!-- Bukti Daftar  -->
    <div id="buktiArea" class="hidden mt-6 mx-4 sm:mx-6 md:mx-10 lg:mx-16 p-4 sm:p-6 bg-white rounded-2xl shadow-md">
      <div id="buktiCard" class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
     
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-3">
         
            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center">
              <img src="logo.png" alt="Logo Sekolah" class="w-24 mx-auto mb-2" id="logoPPDB">

            </div>
            <div>
              <div class="text-sm font-semibold">SMP ISLAM ULUN NUHA</div>
              <div class="text-xs text-gray-600">Penerimaan Peserta Didik Baru (PPDB)</div>
            </div>
          </div>
          <div class="text-right text-xs text-gray-600">
            <div id="buktiTanggal">Tanggal: -</div>
            <div class="text-xs">No. Pendaftaran: <span id="buktiNo"></span></div>
          </div>
        </div>

        <hr class="my-2">

        <div class="text-sm">
          <table class="w-full text-sm">
            <tr><td class="py-1 font-medium w-36">Nama</td><td class="py-1" id="buktiNama">-</td></tr>
            <tr><td class="py-1 font-medium">NIK</td><td class="py-1" id="buktiNIK">-</td></tr>
            <tr><td class="py-1 font-medium">Tempat, Tgl Lahir</td><td class="py-1" id="buktiTTL">-</td></tr>
            <tr><td class="py-1 font-medium">Sekolah Asal</td><td class="py-1" id="buktiSekolah">-</td></tr>
            <tr><td class="py-1 font-medium">Unit Saudara</td><td class="py-1" id="buktiUnit">-</td></tr>
          </table>
        </div>

        <div class="flex items-center justify-between mt-4">
          <div class="text-xs text-gray-600">Simpan bukti ini dan tunjukkan saat ujian PPDB.</div>
          <div class="flex items-center gap-3">
            <div id="qrcodeBukti" class="p-2 bg-white rounded-md"></div>
          </div>
        </div>

        <div class="mt-4 flex gap-2">
         <div class="flex flex-col sm:flex-row gap-3 w-full mt-4">
  <button 
    id="downloadPngBtn" 
    class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-xl shadow transition-all duration-150 w-full sm:w-auto hover:scale-[1.02]">
    Download PNG
  </button>

  <button 
    id="downloadPdfBtn" 
    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-xl shadow transition-all duration-150 w-full sm:w-auto hover:scale-[1.02]">
    Download PDF
  </button>

  <button 
    id="closeBuktiBtn" 
    class="flex-1 bg-red-100 hover:bg-red-200 text-gray-700 font-semibold py-2 px-4 rounded-xl shadow transition-all duration-150 w-full sm:w-auto hover:scale-[1.02]">
    Tutup
  </button>
</div>

        </div>
      </div>
    </div>

  </div>
</main>

<!-- Footer -->
<footer class="text-center text-sm text-gray-500 py-4">
  &copy; 2025 PPDB Online | SMP ISLAM ULUN NUHA
</footer>

<!-- Animasi -->
<style>
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fadeIn { animation: fadeIn 0.6s ease-out; }
</style>


<script>
/* ========== Utility Cookie Functions ========== */
function setCookie(name, value, days = 30) {
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  const expires = "expires="+ d.toUTCString();
  document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
}
function getCookie(name){
  const v = `; ${document.cookie}`;
  const parts = v.split(`; ${name}=`);
  if(parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  return null;
}

// --- Load data user dari cookie / localStorage ---
  const nama = getCookie('nama');
const nik = getCookie('nik');
document.getElementById('userInfo').innerHTML = `
  <div class="font-bold">${nama}</div>
  <div class="text-xs text-white">(${nik})</div>
`;

// Tampilkan nama di Beranda
document.getElementById('userNama').innerHTML = `<div class="font-bold text-xl">${nama} !</div>`;



function deleteCookie(name){
  document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
}



/* ========== Logout ========== */
document.getElementById('logoutBtn').addEventListener('click', ()=> {
  Swal.fire({
    title: 'Keluar dari akun?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Ya, Logout',
    cancelButtonText: 'Batal'
  }).then((result) => {
    if(result.isConfirmed){
      deleteCookie('token');
      deleteCookie("nik");
      deleteCookie("nama");
      
      // deleteCookie('nik');
      Swal.fire({ title: 'Logout berhasil', icon: 'success', timer: 1200, showConfirmButton: false });
      setTimeout(()=> window.location.href = 'loginSKA.html', 1200);
    }
  });
});

/* ========== Global config ========== */
const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbze0REuKPMBPVKAQ-d5qpgv3xpHhqIUzS5MJ-agOUUWuTpvSlT1LkmH2gIezV_Qs-I6tg/exec'; // ganti jika beda
const token = getCookie('token');
if(!token) {

  window.location.href = 'loginSKA.html';
}

/* ========== Load User Data (existing behaviour preserved) ========== */
async function loadUserData() {
      deleteCookie("nik");
      deleteCookie("nama");
  Swal.fire({
    title: 'Memuat data...',
    didOpen: () => Swal.showLoading(),
    allowOutsideClick: false
    
  });

  const formData = new URLSearchParams();
  formData.append('action', 'getUserData');
  formData.append('token', token);

  try {
    const response = await fetch(GAS_ENDPOINT, { method: 'POST', body: formData });
    const result = await response.json();
    Swal.close();

    if (result.status === 'success') {
      const data = result.data || {};

    
      document.getElementById('namaSiswa').value = data.namaSiswa || '';
      document.getElementById('tempat').value = data.tempatLahir || '';
      

      
      if (data.tanggalLahir) {
        let formattedDate = data.tanggalLahir;

      
        if (typeof formattedDate === 'object') {
          formattedDate = new Date(formattedDate).toISOString().split('T')[0];
        } else if (typeof formattedDate === 'string') {
         
          const parsed = new Date(formattedDate);
          if (!isNaN(parsed)) {
            formattedDate = parsed.toISOString().split('T')[0];
          }
        }

        document.getElementById('tanggal').value = formattedDate;
      } else {
        document.getElementById('tanggal').value = '';
      }

      document.getElementById('namaAyah').value = data.namaAyah || '';
      document.getElementById('namaIbu').value = data.namaIbu || '';
      document.getElementById('sekolahAsal').value = data.sekolahAsal || '';
      document.getElementById('alamat').value = data.alamat || '';
      document.getElementById('namaSaudara').value = data.namaSaudara || '';
      document.getElementById('unitSaudara').value = data.unitSaudara || '';
      document.getElementById('jk').value = data.jenisKelamin || '';
      document.getElementById('anakke').value = data.anakKe || '';
      document.getElementById('tanggalDaftar').value = data.tanggalDaftar || '';
      document.getElementById('noPendaftaran').value = data.noPendaftaran || '';

      
     
   
      const isiPengumuman = document.getElementById('isiPengumuman');
      if (data.pengumuman) {
  
        const safeHtml = data.pengumuman.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi, '');
        isiPengumuman.innerHTML = safeHtml;
      } else {
        isiPengumuman.innerHTML = '<em>Tidak ada pengumuman untuk saat ini.</em>';
      }


      

       
      // file links
      document.getElementById('kkLink').innerHTML = data.kk
        ? `<a href="${data.kk}" target="_blank" class="text-blue-500 underline">Lihat</a>`
        : 'Belum upload';
      document.getElementById('skLink').innerHTML = data.sk
        ? `<a href="${data.sk}" target="_blank" class="text-blue-500 underline">Lihat</a>`
        : 'Belum upload';

   
       
    const setujuCheckbox = document.getElementById('setuju');
    const startFormButton = document.getElementById('startForm');
    const infoLengkap = document.getElementById('infoLengkap'); // elemen kosong buat pesan
    const syaratPengisian = document.getElementById('syaratPengisian');

    if (data.lengkap === 'YA') {
      setujuCheckbox.checked = true;

      // üîΩ Sembunyikan tombol Mulai Isi Form
      if (startFormButton) startFormButton.style.display = 'none';
      

      // üîΩ Tampilkan pesan ‚ÄúData kamu sudah lengkap‚Äù
      if (infoLengkap) {
        infoLengkap.innerHTML = `
          <div class="p-3 bg-yellow-100 border border-green-300 text-green-700 rounded-lg mt-3 text-center font-semibold">
            ‚úÖ Data kamu sudah lengkap. Syukron telah mendaftar, lihat bukti daftar di beranda!
            
          </div>
        `;
      }

      
   
    } else {
      // Jika belum lengkap tombol muncul dan pesan dihapus
      if (startFormButton) startFormButton.style.display = 'inline-block';
      if (infoLengkap) infoLengkap.innerHTML = '';
      if (syaratPengisian) syaratPengisian.classList.remove('hidden');
      
    }


         
      const saveBtn = document.getElementById('saveBtn');
      const previewBtn = document.getElementById('previewBuktiBtn');
      const pernyataan = document.getElementById('pernyataan');

      if (data.lengkap && data.lengkap.toString().toUpperCase() === 'YA') {
      
        document.querySelectorAll('#dataForm input, #dataForm select, #dataForm textarea').forEach(el => {
          el.disabled = true;
          el.classList.add('bg-gray-100', 'cursor-not-allowed');
        });

        // Checkbox pernyataan di-disable dan dicentang otomatis
        if (pernyataan) {
          pernyataan.checked = true;
          pernyataan.disabled = true;
        }

 
        saveBtn.classList.add('hidden');
        previewBtn.classList.remove('hidden');
        previewBtn.textContent = 'Lihat Bukti Daftar';
      } else {
        // Kalau belum lengkap: pastikan tombol simpan muncul
        document.querySelectorAll('#dataForm input, #dataForm select, #dataForm textarea').forEach(el => {
          el.disabled = false;
          el.classList.remove('bg-gray-100', 'cursor-not-allowed');
        });

        if (pernyataan) {
          pernyataan.disabled = false;
          pernyataan.checked = false;
        }

        saveBtn.classList.remove('hidden');
        previewBtn.classList.add('hidden');
      }
      

      if (data.nik) {
  
      if (data.nik) setCookie('nik', data.nik, 365);
      if (data.namaSiswa) setCookie('nama', data.namaSiswa, 365);

      }
    } else {
      Swal.fire('Error', result.message || 'Gagal memuat data', 'error');
    }
  } catch (err) {
    Swal.close();
    Swal.fire('Error', 'Terjadi kesalahan koneksi ke server.', 'error');
    console.error(err);
  }
}

loadUserData();


/* ========== Submit/Update Data (preserve original logic) ========== */
document.getElementById('dataForm').addEventListener('submit', async function(e){
  e.preventDefault();
  // ambil nilai
  const namaSiswa = document.getElementById('namaSiswa').value.trim();
  const tempat = document.getElementById('tempat').value.trim();
  const tanggal = document.getElementById('tanggal').value;
  const jk = document.getElementById('jk').value;
  const namaAyah = document.getElementById('namaAyah').value.trim();
  const namaIbu = document.getElementById('namaIbu').value.trim();
  const sekolahAsal = document.getElementById('sekolahAsal').value.trim();
  const alamat = document.getElementById('alamat').value.trim();
  const namaSaudara = document.getElementById('namaSaudara').value.trim();
  const unitSaudara = document.getElementById('unitSaudara').value;
  const anakke = document.getElementById('anakke').value;

  const kkFile = document.getElementById('kkFile').files[0];
  const skFile = document.getElementById('skFile').files[0];

  // status teks upload (dari innerText)
  const kkStatus = document.getElementById('kkLink').innerText.trim();
  const skStatus = document.getElementById('skLink').innerText.trim();
  

  // validasi: jika sebelumnya belum upload (Belum upload) maka wajib pilih file
  if (kkStatus === 'Belum upload' && !kkFile) {
  Swal.fire('Wajib Upload!', 'Silakan upload file Kartu Keluarga terlebih dahulu.', 'warning');
  return;
}



// ‚úÖ Validasi SK hanya jika unit bukan SMP
if (unitSaudara !== 'SMP' && skStatus === 'Belum upload' && !skFile) {
  Swal.fire('Wajib Upload!', 'Silakan upload file Surat Keterangan terlebih dahulu.', 'warning');
  return;
}


  // --- Fungsi bantu: kompres gambar sebelum diubah ke base64 ---
async function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.7) {
  return new Promise((resolve, reject) => {
    if (!file.type.startsWith('image/')) {
      // kalau bukan gambar, lewati kompres
      resolve(file);
      return;
    }

    const img = new Image();
    const url = URL.createObjectURL(file);
    img.src = url;

    img.onload = () => {
      URL.revokeObjectURL(url);

      const canvas = document.createElement('canvas');
      let width = img.width;
      let height = img.height;

      // atur proporsi
      if (width > height) {
        if (width > maxWidth) {
          height *= maxWidth / width;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width *= maxHeight / height;
          height = maxHeight;
        }
      }

      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);

      canvas.toBlob(
        (blob) => {
          if (blob) {
            const newFile = new File([blob], file.name, { type: blob.type });
            resolve(newFile);
          } else {
            reject(new Error('Gagal mengompres gambar.'));
          }
        },
        'image/jpeg',
        quality
      );
    };

    img.onerror = (err) => {
      URL.revokeObjectURL(url);
      reject(err);
    };
  });
}

// --- Fungsi bantu: ubah file jadi base64 ---
function readFileBase64(file) {
  return new Promise(resolve => {
    if (!file) resolve('');
    else {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result.split(',')[1]);
      reader.readAsDataURL(file);
    }
  });
}



 


  // disable tombol simpan untuk mencegah klik ganda
  const saveBtn = document.getElementById('saveBtn');
  saveBtn.disabled = true;
  saveBtn.classList.add('opacity-60','cursor-not-allowed');

  Swal.fire({
    title: 'Menyimpan data...',
    text: 'Mohon tunggu, sedang menyimpan ke server...',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    let kkBase64 = '';
    let skBase64 = '';

    if (kkFile) {
      const compressedKK = await compressImage(kkFile);
      kkBase64 = await readFileBase64(compressedKK);
    }

    if (skFile) {
      const compressedSK = await compressImage(skFile);
      skBase64 = await readFileBase64(compressedSK);
    }


    const formData = new URLSearchParams();
    formData.append('action','lengkapiData');
    formData.append('token', token);
    formData.append('namaSiswa', namaSiswa);
    formData.append('tempat', tempat);
    formData.append('tanggal', tanggal);
    formData.append('jk', jk);
    formData.append('namaAyah', namaAyah);
    formData.append('namaIbu', namaIbu);
    formData.append('sekolahAsal', sekolahAsal);
    formData.append('alamat', alamat);
    formData.append('namaSaudara', namaSaudara);
    formData.append('unitSaudara', unitSaudara);
    formData.append('anakke', anakke);
    formData.append('kkFile', kkBase64);
    formData.append('skFile', skBase64);
    formData.append('Lengkap', 'TRUE'); // tandai bahwa form sudah lengkap & disetujui

    

    const response = await fetch(GAS_ENDPOINT, { method:'POST', body: formData });
    const result = await response.json();
    Swal.close();
    saveBtn.disabled = false;
    saveBtn.classList.remove('opacity-60','cursor-not-allowed');

    if(result.status === 'success'){
      Swal.fire({
        icon: 'success',
        title: 'Data Berhasil Disimpan',
        text: 'Silakan lihat download bukti daftar di beranda.',
        timer: 2500,
        showConfirmButton: false
      }).then(()=> {
        loadUserData();
        // kunci seluruh input agar tidak bisa diedit
        document.querySelectorAll('#dataForm input, #dataForm select, #dataForm textarea').forEach(el => {
          el.disabled = true;
          el.classList.add('bg-gray-100','cursor-not-allowed');
        });

        // sembunyikan tombol simpan, tampilkan tombol bukti daftar
        saveBtn.classList.add('hidden');
        previewBtn.classList.remove('hidden');
        previewBtn.textContent = 'Lihat Bukti Daftar';

        // reload data form kalau mau sync ke server
        loadUserData();
      });
    } else {
      Swal.fire('Gagal', result.message || 'Gagal menyimpan data','error');
    }
  } catch (err) {
    Swal.close();
    saveBtn.disabled = false;
    saveBtn.classList.remove('opacity-60','cursor-not-allowed');
    Swal.fire('Error', 'Terjadi kesalahan koneksi ke server.', 'error');
    console.error(err);
  }
});

/* ========== Bukti Daftar (client-side) ========== */
/*
- NIK diambil dari cookie 'nik' jika ada, jika tidak ambil dari server (variabel local saat loadUserData akan mencoba menyimpan data.nik ke cookie)
- QR dibangun dari NIK (kamu bisa ubah format QR menjadi misalnya: "PPDB|NIK|Nama|Tanggal")
*/

const previewBuktiBtn = document.getElementById('previewBuktiBtn');
const buktiArea = document.getElementById('buktiArea');
const qrcodeBuktiEl = document.getElementById('qrcodeBukti');

let lastBuktiData = {}; // simpan data terakhir untuk export

previewBuktiBtn.addEventListener('click', async () => {
  // ambil NIK dari cookie, fallback ke server data jika cookie belum ada
  let nik = getCookie('nik') || '';
  // ambil data form sebagai sumber data utama (supaya user bisa lihat preview sebelum simpan)
  const nama = document.getElementById('namaSiswa').value.trim();
  const tempat = document.getElementById('tempat').value.trim();
  const tanggal = document.getElementById('tanggalDaftar').value;
  const sekolahAsal = document.getElementById('sekolahAsal').value.trim();
  const unitSaudara = document.getElementById('unitSaudara').value;
  const noDaftar = document.getElementById('noPendaftaran').value;
  const tglLhr = document.getElementById('tanggal').value;

  
  

  if(!nik){
    // kalau cookie tidak ada, coba minta server (sinkron) untuk memastikan ‚Äî gunakan getUserData quick call
    try {
      const tmp = new URLSearchParams();
      tmp.append('action','getUserData');
      tmp.append('token', token);
      const resp = await fetch(GAS_ENDPOINT, { method:'POST', body: tmp });
      const resj = await resp.json();
      if(resj.status === 'success' && resj.data && resj.data.nik){
        nik = resj.data.nik;
        setCookie('nik', nik, 365);
      }
    } catch(e) {
      console.warn('Gagal ambil NIK dari server', e);
    }
  }

  if(!nik){
    // beri pilihan kepada user jika NIK tidak tersedia
    const { value: manualNik } = await Swal.fire({
      title: 'NIK tidak ditemukan',
      input: 'text',
      inputLabel: 'Masukkan NIK (otomatis disimpan di cookie)',
      inputPlaceholder: 'Contoh: 3275xxxxxxxxxxxx',
      showCancelButton: true
    });
    if(manualNik){
      nik = manualNik.trim();
      setCookie('nik', nik, 365);
    } else {
      return; // batal
    }
  }

  // Format tampilan bukti
  const tanggalText = tanggal ? (new Date(tanggal)).toLocaleDateString('id-ID') : '-';
  const tanggalNow = new Date().toLocaleDateString('id-ID');
  const buktiTglLhr = tglLhr ? (new Date(tglLhr)).toLocaleDateString('id-ID') : '-';

  

  document.getElementById('buktiNama').textContent = nama || '-';
  document.getElementById('buktiNIK').textContent = nik;
  document.getElementById('buktiTTL').textContent = (tempat || '-') + ', ' + (buktiTglLhr || '-');
  document.getElementById('buktiSekolah').textContent = sekolahAsal || '-';
  document.getElementById('buktiUnit').textContent = unitSaudara || '-';
  document.getElementById('buktiTanggal').textContent = 'Tanggal: ' + tanggalText;
  // nomor pendaftaran: gabungan token + waktu (bisa disesuaikan)
  document.getElementById('buktiNo').textContent = noDaftar || '-';

  // generate QR
  qrcodeBuktiEl.innerHTML = '';
  // isi QR: kita buat format => "PPDB|NIK|Nama|TanggalGenerate"
  const qrText = `PPDB|${nik}|${nama || '-'}|${noDaftar}`;
  new QRCode(qrcodeBuktiEl, {
    text: qrText,
    width: 120,
    height: 120,
    correctLevel: QRCode.CorrectLevel.H
  });

  // simpan data untuk export
  lastBuktiData = {
    nama: nama || '-',
    nik,
    ttl: (tempat || '-') + ', ' + buktiTglLhr,
    sekolah: sekolahAsal || '-',
    unit: unitSaudara || '-',
    tanggalCetak: tanggalNow,
    noDaftar,
    qrText
  };

  // tampilkan area bukti
  buktiArea.classList.remove('hidden');
  // scroll ke area bukti
  buktiArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
});

/* Tutup bukti */
document.getElementById('closeBuktiBtn').addEventListener('click', () => {
  buktiArea.classList.add('hidden');
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

/* ========== Download PNG Bukti (dengan perbesar & sembunyikan tombol) ========== */
document.getElementById('downloadPngBtn').addEventListener('click', async () => {
  const buktiCard = document.getElementById('buktiCard');
  

  // üîπ Sembunyikan semua tombol dalam bukti
  const buttons = buktiCard.querySelectorAll('button');
  buttons.forEach(btn => (btn.style.display = 'none'));

  // üîπ Simpan ukuran lama lalu ubah agar hasil gambar lebih besar dan rapi
  const oldWidth = buktiCard.style.width;
  const oldTransform = buktiCard.style.transform;
  const oldMargin = buktiCard.style.margin;

  buktiCard.style.width = '600px';
  buktiCard.style.transform = 'scale(1)';
  buktiCard.style.transformOrigin = 'top left';
  buktiCard.style.margin = '0 auto';

  try {
    const canvas = await html2canvas(buktiCard, {
      scale: 3,
      useCORS: true,
      backgroundColor: "#ffffff"
    });

    // üîπ Kembalikan gaya ke semula
    buktiCard.style.width = oldWidth;
    buktiCard.style.transform = oldTransform;
    buktiCard.style.margin = oldMargin;

    // üîπ Tampilkan kembali tombol
    buttons.forEach(btn => (btn.style.display = ''));

    // üîπ Unduh gambar
    const link = document.createElement('a');
    link.download = `Bukti_PPDB_${lastBuktiData.nama || 'Siswa'}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();

    Swal.close();
    Swal.fire('Berhasil!', 'Bukti berhasil diunduh sebagai PNG.', 'success');
  } catch (error) {
    console.error(error);
    Swal.close();
    Swal.fire('Gagal', 'Terjadi kesalahan saat membuat gambar.', 'error');

    // Pastikan tombol muncul lagi walau error
    buttons.forEach(btn => (btn.style.display = ''));
  }
});

/* ========== Download PDF Bukti (dengan perbesar & sembunyikan tombol) ========== */
document.getElementById('downloadPdfBtn').addEventListener('click', async () => {
  const buktiCard = document.getElementById('buktiCard');
  

  // üîπ Sembunyikan semua tombol di dalam bukti
  const buttons = buktiCard.querySelectorAll('button');
  buttons.forEach(btn => (btn.style.display = 'none'));

  // üîπ Simpan ukuran lama dan ubah agar hasil PDF lebih besar dan proporsional
  const oldWidth = buktiCard.style.width;
  const oldTransform = buktiCard.style.transform;
  const oldMargin = buktiCard.style.margin;

  buktiCard.style.width = '600px';
  buktiCard.style.transform = 'scale(1)';
  buktiCard.style.transformOrigin = 'top left';
  buktiCard.style.margin = '0 auto';

  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'pt',
      format: 'a4'
    });

    const canvas = await html2canvas(buktiCard, {
      scale: 3,
      useCORS: true,
      backgroundColor: "#ffffff"
    });
    const imgData = canvas.toDataURL('image/png');

    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

    pdf.save(`Bukti_PPDB_${lastBuktiData.nama || 'Siswa'}.pdf`);
    Swal.close();
    Swal.fire('Berhasil!', 'Bukti berhasil diunduh sebagai PDF.', 'success');
  } catch (error) {
    console.error(error);
    Swal.close();
    Swal.fire('Gagal', 'Terjadi kesalahan saat membuat PDF.', 'error');
  } finally {
    // üîπ Kembalikan tampilan semula
    buktiCard.style.width = oldWidth;
    buktiCard.style.transform = oldTransform;
    buktiCard.style.margin = oldMargin;
    buttons.forEach(btn => (btn.style.display = ''));
  }
});


</script>

</body>
</html>

